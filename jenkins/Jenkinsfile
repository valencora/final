pipeline {

    agent any

    

    environment {

        DOCKER_IMAGE = 'blogapp/blog-app'  

        DOCKER_TAG = "${env.BUILD_NUMBER}"

    }

    

    stages {

        stage('Checkout') {

            steps {

                checkout scm

            }

        }

        

        stage('Build') {

            steps {

                dir('backend') {

                    sh 'mvn clean package -DskipTests -B'

                }

            }

        }

        

        stage('Test') {

            steps {

                dir('backend') {

                    sh 'mvn test'

                }

            }

            post {

                always {

                    junit 'backend/target/surefire-reports/**/*.xml'

                }

            }

        }

        

        stage('Package') {

            steps {

                dir('backend') {

                    sh 'mvn -ntp -Pprod clean package -DskipTests'

                }

            }

        }

        

        stage('Publish Docker Image') {

            steps {

                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', passwordVariable: 'DOCKER_REGISTRY_PWD', usernameVariable: 'DOCKER_REGISTRY_USER')]) {

                    dir('backend') {

                        sh "mvn -ntp jib:build -Djib.to.image=${DOCKER_IMAGE}:${DOCKER_TAG} -Djib.to.tags=latest,${DOCKER_TAG}"

                    }

                }

            }

        }

    }

    

    post {

        success {

            echo ":white_check_mark: Pipeline completed successfully! Image: ${DOCKER_IMAGE}:${DOCKER_TAG}"

        }

        failure {

            echo ":x: Pipeline failed!"

        }

        always {

            // Limpiar workspace con manejo de errores

            script {

                try {

                    cleanWs()

                } catch (Exception e) {

                    echo ":warning: No se pudo limpiar el workspace: ${e.message}"

                }

            }

        }

    }

}

